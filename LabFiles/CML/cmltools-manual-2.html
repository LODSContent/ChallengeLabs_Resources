<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CML Tools & Validation Manual</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9fb;
        }
        header {
            background: linear-gradient(135deg, #1a5fb4, #0066cc);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { margin: 0; font-size: 2.4em; }
        h2 { 
            color: #1a5fb4; 
            border-bottom: 2px solid #e0e0e0; 
            padding-bottom: 8px; 
            margin-top: 35px;
        }
        h3 { color: #0066cc; margin-top: 25px; }
        pre, code {
            background-color: #f4f4f8;
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            border: 1px solid #ddd;
        }
        code { padding: 2px 6px; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background-color: #1a5fb4;
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) { background-color: #f8f9fa; }
        .toc {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .toc ul { padding-left: 20px; }
        .note {
            background-color: #e3f2fd;
            border-left: 5px solid #1a5fb4;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 6px 6px 0;
        }
        .highlight {
            background-color: #fff8e1;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #ff9800;
        }
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

<header>
    <h1>CML Tools & Validation Manual</h1>
    <p><strong>Version:</strong> 1.20251029.0151 | <strong>Date:</strong> October 29, 2025</p>
    <p><strong>Authors:</strong> xAI Engineering Team</p>
    <p><strong>Target Environment:</strong> Cisco Modeling Labs (CML) + PyATS Validation</p>
</header>

<div class="toc">
    <h2>Table of Contents</h2>
    <ul>
        <li><a href="#overview">1. Overview</a></li>
        <li><a href="#setup-script">2. Setup Script (<code>setup_cml.sh</code>)</a></li>
        <li><a href="#python-library">3. Python Library (<code>cmltools.py</code>)</a>
            <ul>
                <li><a href="#commands">Commands</a></li>
                <li><a href="#env-vars">Environment Variables</a></li>
                <li><a href="#key-classes">Key Classes & Methods</a></li>
            </ul>
        </li>
        <li><a href="#validation-json">4. Validation JSON Schema & Usage</a>
            <ul>
                <li><a href="#structure">Structure</a></li>
                <li><a href="#default-behavior">Default Behavior</a></li>
                <li><a href="#examples">Permutations & Examples</a></li>
            </ul>
        </li>
        <li><a href="#validation-script">5. Validation Script (<code>validate.sh</code>)</a></li>
        <li><a href="#troubleshooting">6. Troubleshooting</a></li>
    </ul>
</div>

<section id="overview">
    <h2>Overview</h2>
    <p>This system enables <strong>automated management and validation</strong> of Cisco CML labs using:</p>
    <ul>
        <li>A <strong>bash setup script</strong> that generates environment and tools</li>
        <li>A <strong>Python CLI tool</strong> (<code>cmltools.py</code>) for CML API interaction</li>
        <li>A <strong>JSON-based validation specification</strong> for device configuration checks</li>
        <li>A <strong>container-safe validation script</strong> for scoring environments</li>
    </ul>
    <div class="note">
        <p><strong>All components are case-insensitive</strong> and support flexible argument styles.</p>
    </div>
</section>

<section id="setup-script">
    <h2>Setup Script (<code>setup_cml.sh</code>)</h2>

    <h3>Purpose</h3>
    <p>Creates:</p>
    <ul>
        <li><code>~/labfiles/cml_env.sh</code> – environment variables + <code>cmltools()</code> wrapper</li>
        <li><code>~/labfiles/cmltools.py</code> – main Python tool</li>
        <li>Auto-sources environment in <code>~/.bashrc</code></li>
    </ul>

    <h3>Usage</h3>
    <pre><code>./setup_cml.sh &lt;CML_IP&gt; &lt;USERNAME&gt; &lt;PASSWORD&gt;</code></pre>

    <h3>Example</h3>
    <pre><code>./setup_cml.sh 192.168.100.10 admin secret</code></pre>

    <h3>Output</h3>
    <pre><code>Environment variables and functions written to /home/labuser/labfiles/cml_env.sh
Added 'source ...' to /home/labuser/.bashrc.
To apply changes: source ~/.bashrc
true</code></pre>

    <div class="note">
        <p>Run <code>source ~/.bashrc</code> or restart shell to use the <code>cmltools</code> command.</p>
    </div>
</section>

<section id="python-library">
    <h2>Python Library (<code>cmltools.py</code>)</h2>

    <h3>CLI Usage</h3>
    <pre><code>cmltools [COMMAND] [LABID] [--deviceinfo JSON] [-source URL] [--debug]
# or
cmltools -command validate -labid LAB2 --deviceinfo '...'</code></pre>
    <p><strong>All flags and values are case-insensitive.</strong></p>

    <h3 id="commands">Commands</h3>
    <table>
        <thead>
            <tr>
                <th>Command</th>
                <th>Description</th>
                <th>Requires LABID?</th>
                <th>Example</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>authenticate</code></td>
                <td>Get JWT token</td>
                <td>No</td>
                <td><code>cmltools authenticate</code></td>
            </tr>
            <tr>
                <td><code>findlab [title]</code></td>
                <td>Find lab by title or default</td>
                <td>Optional</td>
                <td><code>cmltools findlab "My Lab"</code></td>
            </tr>
            <tr>
                <td><code>getlabs</code></td>
                <td>List all lab IDs</td>
                <td>No</td>
                <td><code>cmltools getlabs</code></td>
            </tr>
            <tr>
                <td><code>getdetails &lt;id&gt;</code></td>
                <td>Lab metadata</td>
                <td>Yes</td>
                <td><code>cmltools getdetails abc-123</code></td>
            </tr>
            <tr>
                <td><code>getstate &lt;id&gt;</code></td>
                <td>Lab state</td>
                <td>Yes</td>
                <td><code>cmltools getstate abc-123</code></td>
            </tr>
            <tr>
                <td><code>startlab [id/title]</code></td>
                <td>Start lab (Free SKU: stops others)</td>
                <td>Optional</td>
                <td><code>cmltools startlab</code></td>
            </tr>
            <tr>
                <td><code>stoplab [id/title]</code></td>
                <td>Stop lab</td>
                <td>Optional</td>
                <td><code>cmltools stoplab</code></td>
            </tr>
            <tr>
                <td><code>gettestbed [id/title]</code></td>
                <td>Get PyATS testbed YAML</td>
                <td>Optional</td>
                <td><code>cmltools gettestbed</code></td>
            </tr>
            <tr>
                <td><code>validate [id] --deviceinfo JSON</code></td>
                <td>Validate config</td>
                <td>Optional</td>
                <td>See below</td>
            </tr>
            <tr>
                <td><code>importlab -source URL</code></td>
                <td>Download & import lab</td>
                <td>No</td>
                <td><code>cmltools importlab -source https://...</code></td>
            </tr>
        </tbody>
    </table>

    <h3 id="env-vars">Environment Variables</h3>
    <table>
        <thead>
            <tr>
                <th>Variable</th>
                <th>Default</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>CML_ADDRESS</code></td>
                <td><code>https://$CML_IP</code></td>
                <td>CML API URL</td>
            </tr>
            <tr>
                <td><code>CML_IP</code></td>
                <td>Required</td>
                <td>CML server IP</td>
            </tr>
            <tr>
                <td><code>CML_USERNAME</code></td>
                <td>Required</td>
                <td>Login user</td>
            </tr>
            <tr>
                <td><code>CML_PASSWORD</code></td>
                <td>Required</td>
                <td>Login password</td>
            </tr>
            <tr>
                <td><code>CML_SKU</code></td>
                <td><code>Free</code></td>
                <td>Enforces single-lab rule</td>
            </tr>
            <tr>
                <td><code>SCRIPT_DEBUG</code></td>
                <td><code>false</code></td>
                <td>Enable debug logs</td>
            </tr>
            <tr>
                <td><code>RETRY_COUNT</code></td>
                <td><code>30</code></td>
                <td>Lab start retries</td>
            </tr>
            <tr>
                <td><code>RETRY_DELAY</code></td>
                <td><code>10</code></td>
                <td>Seconds between retries</td>
            </tr>
        </tbody>
    </table>

    <h3 id="key-classes">Key Classes & Methods</h3>

    <h4><code>CMLClient</code></h4>
    <p>Main interface to CML REST API.</p>
    <table>
        <thead>
            <tr>
                <th>Method</th>
                <th>Purpose</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>authenticate()</code></td>
                <td>Login to JWT</td>
            </tr>
            <tr>
                <td><code>findlab(title)</code></td>
                <td>Title to UUID</td>
            </tr>
            <tr>
                <td><code>startlab(id)</code></td>
                <td>Starts lab; stops others in Free SKU</td>
            </tr>
            <tr>
                <td><code>gettestbed(id)</code></td>
                <td>Returns PyATS YAML</td>
            </tr>
            <tr>
                <td><code>validate(id, device_info)</code></td>
                <td>Runs config checks</td>
            </tr>
        </tbody>
    </table>

    <h4><code>validate_pattern()</code></h4>
    <p>Supports:</p>
    <ul>
        <li><code>match_type: "wildcard"</code> to <code>re.escape() + * to .*</code></li>
        <li><code>match_type: "regex"</code> to raw regex</li>
        <li><strong>Default:</strong> <code>wildcard</code></li>
    </ul>
</section>

<section id="validation-json">
    <h2>Validation JSON Schema & Usage</h2>
    <p>Used with <code>validate</code> command via <code>--deviceinfo</code>.</p>

    <h3 id="structure">Structure</h3>
    <pre><code>[
  {
    "device_name": "string",                    // Required: matches testbed device
    "credentials": {                            // Optional: overrides default
      "username": "string",
      "password": "string"
    },
    "commands": [
      {
        "command": "string",                  // Required
        "validations": [                      // Optional: if missing to pass
          {
            "pattern": "string",              // Required
            "match_type": "wildcard|regex"    // Optional: default = wildcard
          }
        ]
      }
    ]
  }
]</code></pre>

    <h3 id="default-behavior">Default Behavior (No JSON)</h3>
    <p>If <code>--deviceinfo</code> is omitted, <code>cmltools</code> auto-generates:</p>
    <table>
        <thead>
            <tr>
                <th>OS</th>
                <th>Command</th>
                <th>Pattern</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>ios</code></td>
                <td><code>show version</code></td>
                <td><code>Cisco IOS Software</code></td>
            </tr>
            <tr>
                <td><code>linux</code></td>
                <td><code>uname -a</code></td>
                <td><code>Linux</code></td>
            </tr>
        </tbody>
    </table>
    <p>All devices in testbed (except <code>terminal_server</code>) are checked.</p>

    <h3 id="examples">Permutations & Examples</h3>

    <div class="highlight">
        <p><strong>1. Minimal (Rely on Defaults)</strong></p>
        <pre><code>cmltools validate -labid MYLAB</code></pre>
        <p>to Uses auto-generated checks.</p>
    </div>

    <div class="highlight">
        <p><strong>2. Single Device, One Check</strong></p>
        <pre><code>[
  {
    "device_name": "R1",
    "commands": [
      {
        "command": "show ip interface brief",
        "validations": [
          { "pattern": "GigabitEthernet0/0.*up.*up" }
        ]
      }
    ]
  }
]</code></pre>
    </div>

    <div class="highlight">
        <p><strong>3. Custom Credentials + Multiple Commands</strong></p>
        <pre><code>[
  {
    "device_name": "HOST1",
    "credentials": { "username": "admin", "password": "cisco" },
    "commands": [
      {
        "command": "cat /etc/hostname",
        "validations": [ { "pattern": "host1" } ]
      },
      {
        "command": "ip addr show eth0",
        "validations": [ { "pattern": "192.168.1.10" } ]
      }
    ]
  }
]</code></pre>
    </div>

    <div class="highlight">
        <p><strong>4. Regex Matching</strong></p>
        <pre><code>[
  {
    "device_name": "SW1",
    "commands": [
      {
        "command": "show vlan brief",
        "validations": [
          {
            "pattern": "^10\\s+Data\\s+active",
            "match_type": "regex"
          }
        ]
      }
    ]
  }
]</code></pre>
    </div>

    <div class="highlight">
        <p><strong>5. Wildcard with Wildcards</strong></p>
        <pre><code>[
  {
    "device_name": "R2",
    "commands": [
      {
        "command": "show running-config | include ntp",
        "validations": [
          { "pattern": "ntp server 1.2.3.4" }
        ]
      }
    ]
  }
]</code></pre>
    </div>

    <div class="highlight">
        <p><strong>6. No Validation (Just Execute)</strong></p>
        <pre><code>[
  {
    "device_name": "R3",
    "commands": [
      { "command": "show clock" }  // No validations to auto-pass
    ]
  }
]</code></pre>
    </div>

    <h3>Validation Output Format</h3>
    <pre><code>Correctly Configured - R1 - show version
Incorrectly Configured - R2 - show ip interface brief
True</code></pre>
    <ul>
        <li>One line per command</li>
        <li>Final line: <code>True</code> or <code>False</code> (overall result)</li>
    </ul>
</section>

<section id="validation-script">
    <h2>Validation Script (<code>validate.sh</code>)</h2>

    <h3>Purpose</h3>
    <p>Container-safe wrapper for scoring systems (e.g., DevNet, Learning@Cisco).</p>

    <h3>Features</h3>
    <ul>
        <li>Hard-coded <code>LAB_ID</code></li>
        <li>Embedded JSON via <code>cat &lt;&lt; 'EOF'</code></li>
        <li>Debug control</li>
        <li>Output filtering</li>
        <li>Exit-code safe</li>
    </ul>

    <h3>Example Snippet</h3>
    <pre><code>LAB_ID="LAB2"
device_info=$(cat &lt;&lt; 'EOF'
[
  {
    "device_name": "switch1",
    "commands": [ { "command": "show version", "validations": [ { "pattern": "Cisco IOS Software" } ] } ]
  }
]
EOF
)</code></pre>

    <h3>Control Variables</h3>
    <table>
        <thead>
            <tr>
                <th>Var</th>
                <th>Values</th>
                <th>Effect</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>scriptDebug</code></td>
                <td><code>true</code>/<code>false</code></td>
                <td>Show debug + errors</td>
            </tr>
            <tr>
                <td><code>showDevices</code></td>
                <td><code>true</code>/<code>false</code></td>
                <td>Show per-device results</td>
            </tr>
        </tbody>
    </table>
</section>

<section id="troubleshooting">
    <h2>Troubleshooting</h2>
    <table>
        <thead>
            <tr>
                <th>Symptom</th>
                <th>Solution</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>cmltools: command not found</code></td>
                <td>Run <code>source ~/.bashrc</code></td>
            </tr>
            <tr>
                <td><code>No valid JWT token</code></td>
                <td>Check username/password, CML reachable</td>
            </tr>
            <tr>
                <td><code>not_in_testbed</code></td>
                <td>Device name mismatch (case-sensitive in testbed)</td>
            </tr>
            <tr>
                <td><code>connect_failed</code></td>
                <td>Wrong credentials or device not started</td>
            </tr>
            <tr>
                <td><code>Pattern not found</code></td>
                <td>Use <code>--debug</code> to see output</td>
            </tr>
            <tr>
                <td><code>Free SKU: stopping other lab</code></td>
                <td>Normal in free tier</td>
            </tr>
        </tbody>
    </table>

    <h3>Enable Debug</h3>
    <pre><code>export SCRIPT_DEBUG=true
cmltools validate --debug</code></pre>
    <p>Logs to: <code>/home/labuser/labfiles/script_log.txt</code></p>
</section>

<section>
    <h2>Summary</h2>
    <table>
        <thead>
            <tr>
                <th>Component</th>
                <th>Role</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>setup_cml.sh</code></td>
                <td>Bootstrap environment</td>
            </tr>
            <tr>
                <td><code>cml_env.sh</code></td>
                <td>Auto-load <code>cmltools()</code></td>
            </tr>
            <tr>
                <td><code>cmltools.py</code></td>
                <td>Core CML + PyATS automation</td>
            </tr>
            <tr>
                <td><code>device_info</code> JSON</td>
                <td>Declarative config validation</td>
            </tr>
            <tr>
                <td><code>validate.sh</code></td>
                <td>Scoring-safe execution</td>
            </tr>
        </tbody>
    </table>

    <div style="text-align: center; margin: 40px 0; font-size: 1.3em; color: #1a5fb4;">
        <p><strong>You now have full control over CML lab lifecycle and configuration validation.</strong></p>
        <p><em>Let’s automate the network.</em></p>
    </div>
</section>

<footer>
    <p>CML Tools v1.20251029.0151 | © 2025 xAI Engineering Team</p>
</footer>

</body>
</html>
